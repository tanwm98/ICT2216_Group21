<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Owner Signup - Kirby Chope</title>
  <link href="/static/styles/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles/style.css">
  <link rel="stylesheet" href="/static/styles/ownerForm.css">
  <div id="head-placeholder"></div>
  <style>
  </style>
</head>

<body>
<div id="header-placeholder"></div>

<div class="main-container">
  <div class="header-section">
    <h2>üçΩÔ∏è Restaurant Owner Registration</h2>
    <p>Join Kirby Chope and start accepting reservations today!</p>
  </div>

  <!-- Enhanced Error Display Section -->
  <div id="errorAlert" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
    <strong>‚ùå Registration Failed!</strong>
    <span id="errorMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Success Alert -->
  <div id="successAlert" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
    <strong>‚úÖ Success!</strong> Your restaurant registration has been submitted successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <form method="POST" action="/signup-owner" enctype="multipart/form-data" id="ownerSignupForm" novalidate>

    <!-- Owner Information Section -->
    <div class="section">
      <h3>üë§ Owner Information</h3>

      <div class="mb-3">
        <label for="ownerName" class="form-label">Owner Username</label>
        <input type="text" class="form-control" id="ownerName" name="ownerName" required
               pattern="^[a-zA-Z0-9_]{3,20}$" title="3-20 characters, letters, numbers, and underscores only">
        <div class="invalid-feedback">
          Username must be 3-20 characters (letters, numbers, underscores only)
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="firstname" class="form-label">First Name</label>
            <input type="text" class="form-control" id="firstname" name="firstname" required
                   pattern="^[a-zA-Z\s]{2,30}$" title="2-30 characters, letters only">
            <div class="invalid-feedback">
              First name must be 2-30 characters (letters only)
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="lastname" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="lastname" name="lastname" required
                   pattern="^[a-zA-Z\s]{2,30}$" title="2-30 characters, letters only">
            <div class="invalid-feedback">
              Last name must be 2-30 characters (letters only)
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" class="form-control" id="email" name="email" required>
        <div class="invalid-feedback">
          Please provide a valid email address
        </div>
      </div>

      <!-- Enhanced Password Fields -->
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" name="password" required
               minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$">
        <div class="password-requirements">
          <strong>Password Requirements:</strong>
          <ul>
            <li>At least 8 characters long</li>
            <li>At least one lowercase letter (a-z)</li>
            <li>At least one uppercase letter (A-Z)</li>
            <li>At least one number (0-9)</li>
            <li>At least one special character (@$!%*?&)</li>
          </ul>
        </div>
        <div class="invalid-feedback">
          Password must meet all security requirements above
        </div>
      </div>

      <div class="mb-3">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
        <div id="passwordError" class="text-danger small" style="display: none;">
          Passwords do not match
        </div>
        <div class="invalid-feedback">
          Please confirm your password
        </div>
      </div>
    </div>

    <!-- Restaurant Information Section -->
    <div class="section">
      <h3>üè™ Restaurant Information</h3>

      <div class="mb-3">
        <label for="storeName" class="form-label">Restaurant Name</label>
        <input type="text" class="form-control" id="storeName" name="storeName" required
               pattern="^[a-zA-Z0-9\s&'-]{2,50}$" title="2-50 characters, letters, numbers, spaces, &, ', -">
        <div class="invalid-feedback">
          Restaurant name must be 2-50 characters
        </div>
      </div>

      <div class="mb-3">
        <label for="address" class="form-label">Address</label>
        <input type="text" class="form-control" id="address" name="address" required
               pattern="^[a-zA-Z0-9\s,.-#]{10,100}$" title="10-100 characters">
        <div class="invalid-feedback">
          Please provide a valid address (10-100 characters)
        </div>
      </div>

      <div class="mb-3">
        <label for="postalCode" class="form-label">Postal Code</label>
        <input type="text" class="form-control" id="postalCode" name="postalCode"
               pattern="[0-9]{6}" title="Please enter a valid 6-digit postal code" required>
        <div class="invalid-feedback">
          Postal code must be exactly 6 digits
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="cuisine" class="form-label">Cuisine Type</label>
            <select class="form-select" id="cuisine" name="cuisine" required>
              <option value="">Select cuisine type...</option>
              <option value="Chinese">Chinese</option>
              <option value="Italian">Italian</option>
              <option value="Japanese">Japanese</option>
              <option value="Thai">Thai</option>
              <option value="Indian">Indian</option>
              <option value="Mexican">Mexican</option>
              <option value="French">French</option>
              <option value="Greek">Greek</option>
              <option value="Korean">Korean</option>
              <option value="Vietnamese">Vietnamese</option>
              <option value="Western">Western</option>
              <option value="Local">Local</option>
              <option value="Other">Other</option>
            </select>
            <div class="invalid-feedback">
              Please select a cuisine type
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="location" class="form-label">Location</label>
            <select class="form-select" id="location" name="location" required>
              <option value="">Select location...</option>
              <option value="Orchard">Orchard</option>
              <option value="Marina Bay">Marina Bay</option>
              <option value="Chinatown">Chinatown</option>
              <option value="Clarke Quay">Clarke Quay</option>
              <option value="Bugis">Bugis</option>
              <option value="Tanjong Pagar">Tanjong Pagar</option>
              <option value="Raffles Place">Raffles Place</option>
              <option value="Sentosa">Sentosa</option>
              <option value="Dhoby Ghaut">Dhoby Ghaut</option>
              <option value="Somerset">Somerset</option>
              <option value="Bukit Timah">Bukit Timah</option>
              <option value="Holland Village">Holland Village</option>
              <option value="Tiong Bahru">Tiong Bahru</option>
              <option value="East Coast">East Coast</option>
              <option value="Katong">Katong</option>
              <option value="Other">Other</option>
            </select>
            <div class="invalid-feedback">
              Please select a location
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="priceRange" class="form-label">Price Range</label>
        <select class="form-select" id="priceRange" name="priceRange" required>
          <option value="">Select price range...</option>
          <option value="$">$ (Under $20 per person)</option>
          <option value="$$">$$ ($20-40 per person)</option>
          <option value="$$$">$$$ ($40-60 per person)</option>
          <option value="$$$$">$$$$ ($60-100 per person)</option>
          <option value="$$$$$">$$$$$ (Over $100 per person)</option>
        </select>
        <div class="invalid-feedback">
          Please select a price range
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="capacity" class="form-label">Seating Capacity (For Reservations)</label>
            <input type="number" class="form-control" id="capacity" name="capacity" min="10" max="500" required>
            <div class="form-text">Number of seats available for online reservations (10-500)</div>
            <div class="invalid-feedback">
              Seating capacity must be between 10 and 500
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="totalCapacity" class="form-label">Total Capacity</label>
            <input type="number" class="form-control" id="totalCapacity" name="totalCapacity" min="10" max="1000" required>
            <div class="form-text">Total restaurant capacity (must be ‚â• seating capacity)</div>
            <div class="invalid-feedback">
              Total capacity must be between 10 and 1000
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="opening" class="form-label">Opening Hour</label>
            <input type="time" class="form-control" id="opening" name="opening" required>
            <div class="invalid-feedback">
              Please select opening hour
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="closing" class="form-label">Closing Hour</label>
            <input type="time" class="form-control" id="closing" name="closing" required>
            <div class="invalid-feedback">
              Please select closing hour
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="image" class="form-label">Upload Restaurant Image *</label>
        <input type="file" class="form-control" id="image" name="image"
               accept="image/jpeg,image/jpg,image/png" required>
        <div class="file-upload-info">
          üì∑ <strong>Image Requirements:</strong><br>
          ‚Ä¢ Format: JPG, JPEG, or PNG only<br>
          ‚Ä¢ Maximum size: 5MB<br>
          ‚Ä¢ Recommended: High-quality photos showcase your restaurant best<br>
          ‚Ä¢ This image will be displayed on your restaurant listing
        </div>
        <div class="invalid-feedback">
          Please upload a restaurant image (JPG, JPEG, or PNG, max 5MB)
        </div>
      </div>

      <div class="mb-4 form-check">
        <input type="checkbox" class="form-check-input" id="terms" required>
        <label class="form-check-label" for="terms">
          I agree to the <a href="#" target="_blank">Terms and Conditions</a> and confirm that all information provided is accurate and I have the legal right to operate this restaurant.
        </label>
        <div class="invalid-feedback">
          You must agree to the terms and conditions
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary btn-lg">
          üöÄ Submit Application
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('ownerSignupForm');
      const password = document.getElementById('password');
      const confirmPassword = document.getElementById('confirmPassword');
      const passwordError = document.getElementById('passwordError');
      const capacity = document.getElementById('capacity');
      const totalCapacity = document.getElementById('totalCapacity');

      // ENHANCED: Security-focused error handling from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const errorAlert = document.getElementById('errorAlert');
      const errorMessage = document.getElementById('errorMessage');
      const successAlert = document.getElementById('successAlert');

      // Handle error parameter with XSS protection
      if (urlParams.has('error')) {
          const errorText = urlParams.get('error');
          if (errorText && errorText !== '1') {
              // XSS protection: escape HTML characters
              const escapeHtml = (unsafe) => {
                  return unsafe
                      .replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
              };
              errorMessage.innerHTML = ` ${escapeHtml(errorText)}`;
          } else {
              errorMessage.textContent = ' Please check your information and try again.';
          }
          errorAlert.style.display = 'block';
          errorAlert.classList.add('show');

          // Scroll to top to show error
          window.scrollTo({ top: 0, behavior: 'smooth' });

          // Remove error parameter from URL to prevent refresh issues
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
      }

      // Handle success parameter
      if (urlParams.has('success')) {
          successAlert.style.display = 'block';
          successAlert.classList.add('show');

          // Redirect to login after 3 seconds
          setTimeout(() => {
              window.location.href = '/login';
          }, 3000);

          // Remove success parameter from URL
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
      }

      // Enhanced password validation with security requirements
      function validatePasswords() {
          if (password.value && confirmPassword.value) {
              if (password.value !== confirmPassword.value) {
                  passwordError.style.display = 'block';
                  confirmPassword.setCustomValidity('Passwords do not match');
                  confirmPassword.classList.add('is-invalid');
                  return false;
              } else {
                  passwordError.style.display = 'none';
                  confirmPassword.setCustomValidity('');
                  confirmPassword.classList.remove('is-invalid');
                  confirmPassword.classList.add('is-valid');
                  return true;
              }
          }
          return true;
      }

      // Enhanced capacity validation
      function validateCapacity() {
          const cap = parseInt(capacity.value);
          const totalCap = parseInt(totalCapacity.value);

          if (cap && totalCap && cap > totalCap) {
              totalCapacity.setCustomValidity('Total capacity must be greater than or equal to seating capacity');
              totalCapacity.classList.add('is-invalid');
              return false;
          } else {
              totalCapacity.setCustomValidity('');
              totalCapacity.classList.remove('is-invalid');
              if (totalCap >= 10) {
                  totalCapacity.classList.add('is-valid');
              }
              return true;
          }
      }

      // Enhanced file validation with security checks
      function validateFile() {
          const fileInput = document.getElementById('image');
          const file = fileInput.files[0];

          if (!file) {
              fileInput.classList.add('is-invalid');
              return false;
          }

          // Security: Check file size (5MB limit)
          if (file.size > 5 * 1024 * 1024) {
              showError('File size must be less than 5MB.');
              fileInput.classList.add('is-invalid');
              return false;
          }

          // Security: Strict file type validation
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
          if (!allowedTypes.includes(file.type)) {
              showError('Please upload a valid image file (JPG, JPEG or PNG only).');
              fileInput.classList.add('is-invalid');
              return false;
          }

          // Security: Check file extension
          const fileName = file.name.toLowerCase();
          const allowedExtensions = ['.jpg', '.jpeg', '.png'];
          const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

          if (!hasValidExtension) {
              showError('Invalid file extension. Only .jpg, .jpeg, .png files are allowed.');
              fileInput.classList.add('is-invalid');
              return false;
          }

          fileInput.classList.remove('is-invalid');
          fileInput.classList.add('is-valid');
          return true;
      }

      // Real-time validation with enhanced feedback
      confirmPassword.addEventListener('input', validatePasswords);
      password.addEventListener('input', () => {
          validatePasswords();
          // Clear invalid state when user starts typing
          if (password.classList.contains('is-invalid')) {
              password.classList.remove('is-invalid');
          }
      });

      capacity.addEventListener('input', validateCapacity);
      totalCapacity.addEventListener('input', validateCapacity);

      // File input validation
      document.getElementById('image').addEventListener('change', validateFile);

      // Enhanced form submission with comprehensive validation
      form.addEventListener('submit', function(e) {
          e.preventDefault(); // Always prevent default, then validate

          // Clear any existing errors
          errorAlert.style.display = 'none';
          errorAlert.classList.remove('show');

          let isValid = true;

          // Validate all required fields
          const requiredFields = form.querySelectorAll('[required]');
          requiredFields.forEach(field => {
              if (!field.checkValidity()) {
                  field.classList.add('is-invalid');
                  isValid = false;
              } else {
                  field.classList.remove('is-invalid');
                  field.classList.add('is-valid');
              }
          });

          // Validate passwords
          if (!validatePasswords()) {
              isValid = false;
          }

          // Validate capacity
          if (!validateCapacity()) {
              isValid = false;
          }

          // Validate file
          if (!validateFile()) {
              isValid = false;
          }

          // Security: Additional time validation
          const opening = document.getElementById('opening').value;
          const closing = document.getElementById('closing').value;

          if (opening && closing && opening >= closing) {
              showError('Closing time must be after opening time.');
              isValid = false;
          }

          if (!isValid) {
              // Focus on first invalid field
              const firstInvalid = form.querySelector('.is-invalid');
              if (firstInvalid) {
                  firstInvalid.focus();
                  firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              return false;
          }

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';

          // Re-enable button after timeout in case of slow response
          setTimeout(() => {
              if (submitBtn.disabled) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalText;
              }
          }, 30000); // 30 second timeout

          // Submit the form
          form.submit();
      });

      // Helper function to show errors with XSS protection
      function showError(message) {
          const escapeHtml = (unsafe) => {
              return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
          };

          errorMessage.innerHTML = ` ${escapeHtml(message)}`;
          errorAlert.style.display = 'block';
          errorAlert.classList.add('show');
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Enhanced Bootstrap validation styling
      form.addEventListener('input', (e) => {
          if (e.target.checkValidity()) {
              e.target.classList.remove('is-invalid');
              e.target.classList.add('is-valid');
          }
      });
  });
</script>
<script src="/common/common_js/include.js"></script>
<script src="/static/styles/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>